---
title: "HW Assignment 2"
author: "MUSA 508 Super Group"
date: "15 September 2023"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

# Setup

```{r setup, include=FALSE, cache = TRUE,message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
```

### Cleaning Workspace & Setup

```{r clear_environment, cache=TRUE,include=F}

rm(list=ls())
```

```{r setup_packages1, warning = FALSE, eval = FALSE,include=F}
install.packages('tidyverse')
install.packages('tidycensus')
install.packages('sf')
install.packages('kableExtra')
```

This analysis used R's `tidyverse`, `tidycensus`, `kableExtra`, and `sf` packages. In our setup, we load the libraries and set some options for a specific color ramp or preventing scientific notation.
```{r code_setup}
library(tidyverse)
library(tidycensus)
library(kableExtra)
library(sf)

# ignore scientific notation
options(scipen=999)
# ensure geometry is in sf format
options(tigris_class="sf")
# set colors for 5 color ramp in palette5
palette5 <- c("#f0f9e8","#bae4bc","#7bccc4","#43a2ca","#0868ac")

# set source url to grab functions from MUSA 5080 book
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

# Timothy's api key: "89824ea2e775e055d3b39974bbc07de16215f217"
census_api_key(Sys.getenv("CENSUS_API_KEY"), overwrite = TRUE)
```

### Use `get_acs()` to get 2016 ACS data

Notice this returns "long" data - let's examine it
`r x<- load_variables(2017,"acs5")`
`
```{r results='hide'}
tracts16 <-  
  get_acs(geography = "tract",
          variables = c("B25026_001E","B02001_002E",
                        "B15001_050E","B15001_009E",
                        "B19013_001E", "B25058_001E",
                        "B06012_002E"),
          year=2016, state="DC", geometry=TRUE) %>% 
  st_transform('ESRI:102685')
```

```{r Timothy_Vars results='hide'}
tracts2020 <-  
  get_acs(geography = "tract",
          
          #             Var ID          Intended Name for Column
          variables = c("B25026_001E", # given var 1
                        "B02001_002E", # given var 2
                        "B15001_050E", # given var 3
                        "B15001_009E", # given var 4
                        "B19013_001E", # given var 5
                        "B25058_001E", # given var 6
                        "B06012_002E"), # given var 7
          
          year=2020, state="DC", geometry=TRUE) %>% 
  st_transform('ESRI:102685') # Maryland's State Plane CS
```

```{r Name_Vars results='hide'}
```
#### Wide data vs long data (and `spread`vs `gather`)


We create a new data frame consisting only of population

```{r}

totalPop16 <-
  tracts16 %>%
  filter(variable == "B25026_001")
```

Ways to examine the data

```{r,include=F,eval=F}
nrow(totalPop16)

names(totalPop16)

head(totalPop16)

glimpse(totalPop16)
```

### Using ggplot to map census data with {sf}

Each plot adds more and more nuance and information

Examine each to see what we've added each time

Consult the textbook to understand the symbology schemes.

(Note: the `qBr()` function used here is an update to the one used
version used in the text book so the results may appear different.)

```{r}
A <- 
  ggplot() +
  geom_sf(data = totalPop16, aes(fill = estimate)) +
  theme(
    plot.title = element_text(size=22)
    )

B <- 
  ggplot() +
  geom_sf(data = totalPop16, aes(fill = q5(estimate))) +
  theme(plot.title = element_text(size=22)) 

C <-
  ggplot() +
  geom_sf(data = totalPop16, aes(fill = q5(estimate))) +
  scale_fill_manual(values = palette5,
                    labels = qBr(totalPop16, "estimate"),
                    name = "Total\nPopluation\n(Quintile Breaks)") +
  theme(plot.title = element_text(size=22))

D <- 
  ggplot() +
  geom_sf(data = totalPop16, aes(fill = q5(estimate))) +
  scale_fill_manual(values = palette5,
                    labels = qBr(totalPop16, "estimate"),
                    name = "Popluation\n(Quintile Breaks)") +
  labs(title = "Total Population", subtitle = "Washington D.C.; 2016") +
  mapTheme() + 
  theme(plot.title = element_text(size=22))
```

### Working with ACS Data

Here we will modify the 2016 ACS by using `spread()` to widen the data
so that each census variable is now a column. We will use `rename()` to
give sensible names to the columns and we will use `mutate()` to make
new features out of the existing columns. These are all steps we had
introduced in Lab 1, except here we are doing it on {sf} spatial data
frames.

```{r}
# Let's "spread" the data into wide form

tracts16 <- 
  tracts16 %>%
  dplyr::select( -NAME, -moe) %>%
  spread(key = variable, value = estimate) %>%
  rename(TotalPop = B25026_001, 
         Whites = B02001_002,
         FemaleBachelors = B15001_050, 
         MaleBachelors = B15001_009,
         MedHHInc = B19013_001, 
         MedRent = B25058_001,
         TotalPoverty = B06012_002)


# Let's create new rate variables using mutate

tracts16 <- 
  tracts16 %>%
  mutate(pctWhite = ifelse(TotalPop > 0, Whites / TotalPop, 0),
         pctBachelors = ifelse(TotalPop > 0, ((FemaleBachelors + MaleBachelors) / TotalPop), 0),
         pctPoverty = ifelse(TotalPop > 0, TotalPoverty / TotalPop, 0),
         year = "2016") %>%
  dplyr::select(-Whites,-FemaleBachelors,-MaleBachelors,-TotalPoverty)
```

Tracts 2016 is now complete. Let's grab 2020 tracts and do the same
thing.

### 2020 Census Data

Notice that we are getting "wide" data here in the first place This
saves us the trouble of using "spread". We do this by using the
`output="wide"` argument to `get_acs()`. IN previous code chunks we
split the use of `get_acs()` to download the data from the use of
`mutate()` and other {dplyr} functions. Here we put the entire process
into one continuous sequence of code using the "pipe" operator `%>%`.

```{r results='hide'}
tracts20 <- 
  get_acs(geography = "tract", 
          variables = c("B25026_001E","B02001_002E",
                        "B15001_050E","B15001_009E",
                        "B19013_001E","B25058_001E",
                        "B06012_002E"), 
          year=2020, state="DC", 
          geometry=TRUE, output="wide") %>%
  st_transform('ESRI:102685') %>%
  rename(TotalPop = B25026_001E, 
         Whites = B02001_002E,
         FemaleBachelors = B15001_050E, 
         MaleBachelors = B15001_009E,
         MedHHInc = B19013_001E, 
         MedRent = B25058_001E,
         TotalPoverty = B06012_002E) %>%
  dplyr::select(-NAME, -starts_with("B")) %>%
  mutate(pctWhite = ifelse(TotalPop > 0, Whites / TotalPop,0), 
         pctBachelors = ifelse(TotalPop > 0, ((FemaleBachelors + MaleBachelors) / TotalPop),0),
         pctPoverty = ifelse(TotalPop > 0, TotalPoverty / TotalPop, 0),
         year = "2020") %>%
  dplyr::select(-Whites, -FemaleBachelors, -MaleBachelors, -TotalPoverty) 
```

## allTracts Creation
```{r}

allTracts <- rbind(tracts16,tracts20)
```

# UnConverted Code: 'Wrangling Transit Open Data' Forward

```{r sessionInfo}
write(capture.output(sessionInfo()),file="requirements.txt")
```