---
title: "HW Assignment 2"
author: "MUSA 508 Super Group"
date: "15 September 2023"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

# Setup

```{r setup, include=FALSE, cache = TRUE,message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
```

### Cleaning Workspace & Setup

```{r clear_environment, cache=TRUE,include=F}

rm(list=ls())
```

```{r setup_packages1, warning = FALSE, eval = FALSE,include=F}
install.packages('tidyverse')
install.packages('tidycensus')
install.packages('sf')
install.packages('kableExtra')
```

This analysis used R's `tidyverse`, `tidycensus`, `kableExtra`, and `sf` packages. In our setup, we load the libraries and set some options for a specific color ramp or preventing scientific notation. 
```{r code_setup}
library(dplyr) #added this, not sure why it wasn't loaded in the lab?
library(tidyverse)
library(tidycensus)
library(kableExtra)
library(sf)

# ignore scientific notation
options(scipen=999)
# ensure geometry is in sf format
options(tigris_class="sf")
# set colors for 5 color ramp in palette5
palette5 <- c("#f0f9e8","#bae4bc","#7bccc4","#43a2ca","#0868ac")

# set source url to grab functions from MUSA 5080 book
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

# Timothy's api key: "89824ea2e775e055d3b39974bbc07de16215f217"
census_api_key(Sys.getenv("CENSUS_API_KEY"), overwrite = TRUE)
```

### Use `get_acs()` to get 2016 ACS data

Notice this returns "long" data - let's examine it
`r x<- load_variables(2017,"acs5")`

```{r results='hide'}
tracts16 <-  
  get_acs(geography = "tract",
          variables = c("B25026_001E","B02001_002E",
                        "B15001_050E","B15001_009E",
                        "B19013_001E", "B25058_001E",
                        "B06012_002E"),
          year=2016, state="DC", geometry=TRUE) %>% 
  st_transform('ESRI:102685')
```
#### Wide data vs long data (and `spread`vs `gather`)


We create a new data frame consisting only of population

```{r}

totalPop16 <-
  tracts16 %>%
  filter(variable == "B25026_001")
```

Ways to examine the data

```{r,include=F,eval=F}
nrow(totalPop16)

names(totalPop16)

head(totalPop16)

glimpse(totalPop16)
```

### Using ggplot to map census data with {sf}

Each plot adds more and more nuance and information

Examine each to see what we've added each time

Consult the textbook to understand the symbology schemes.

(Note: the `qBr()` function used here is an update to the one used
version used in the text book so the results may appear different.)

```{r}
A <- 
  ggplot() +
  geom_sf(data = totalPop16, aes(fill = estimate)) +
  theme(
    plot.title = element_text(size=22)
    )

B <- 
  ggplot() +
  geom_sf(data = totalPop16, aes(fill = q5(estimate))) +
  theme(plot.title = element_text(size=22)) 

C <-
  ggplot() +
  geom_sf(data = totalPop16, aes(fill = q5(estimate))) +
  scale_fill_manual(values = palette5,
                    labels = qBr(totalPop16, "estimate"),
                    name = "Total\nPopluation\n(Quintile Breaks)") +
  theme(plot.title = element_text(size=22))

D <- 
  ggplot() +
  geom_sf(data = totalPop16, aes(fill = q5(estimate))) +
  scale_fill_manual(values = palette5,
                    labels = qBr(totalPop16, "estimate"),
                    name = "Popluation\n(Quintile Breaks)") +
  labs(title = "Total Population", subtitle = "Washington D.C.; 2016") +
  mapTheme() + 
  theme(plot.title = element_text(size=22))
```

### Working with ACS Data

Here we will modify the 2016 ACS by using `spread()` to widen the data
so that each census variable is now a column. We will use `rename()` to
give sensible names to the columns and we will use `mutate()` to make
new features out of the existing columns. These are all steps we had
introduced in Lab 1, except here we are doing it on {sf} spatial data
frames.

```{r}
# Let's "spread" the data into wide form

tracts16 <- 
  tracts16 %>%
  dplyr::select( -NAME, -moe) %>%
  spread(key = variable, value = estimate) %>%
  rename(TotalPop = B25026_001, 
         Whites = B02001_002,
         FemaleBachelors = B15001_050, 
         MaleBachelors = B15001_009,
         MedHHInc = B19013_001, 
         MedRent = B25058_001,
         TotalPoverty = B06012_002)


# Let's create new rate variables using mutate

tracts16 <- 
  tracts16 %>%
  mutate(pctWhite = ifelse(TotalPop > 0, Whites / TotalPop, 0),
         pctBachelors = ifelse(TotalPop > 0, ((FemaleBachelors + MaleBachelors) / TotalPop), 0),
         pctPoverty = ifelse(TotalPop > 0, TotalPoverty / TotalPop, 0),
         year = "2016") %>%
  dplyr::select(-Whites,-FemaleBachelors,-MaleBachelors,-TotalPoverty)
```

Tracts 2016 is now complete. Let's grab 2020 tracts and do the same
thing.

### 2020 Census Data

Notice that we are getting "wide" data here in the first place This
saves us the trouble of using "spread". We do this by using the
`output="wide"` argument to `get_acs()`. IN previous code chunks we
split the use of `get_acs()` to download the data from the use of
`mutate()` and other {dplyr} functions. Here we put the entire process
into one continuous sequence of code using the "pipe" operator `%>%`.

```{r results='hide'}
tracts20 <- 
  get_acs(geography = "tract", 
          variables = c("B25026_001E","B02001_002E",
                        "B15001_050E","B15001_009E",
                        "B19013_001E","B25058_001E",
                        "B06012_002E"), 
          year=2020, state="DC", 
          geometry=TRUE, output="wide") %>%
  st_transform('ESRI:102685') %>%
  rename(TotalPop = B25026_001E, 
         Whites = B02001_002E,
         FemaleBachelors = B15001_050E, 
         MaleBachelors = B15001_009E,
         MedHHInc = B19013_001E, 
         MedRent = B25058_001E,
         TotalPoverty = B06012_002E) %>%
  dplyr::select(-NAME, -starts_with("B")) %>%
  mutate(pctWhite = ifelse(TotalPop > 0, Whites / TotalPop,0), 
         pctBachelors = ifelse(TotalPop > 0, ((FemaleBachelors + MaleBachelors) / TotalPop),0),
         pctPoverty = ifelse(TotalPop > 0, TotalPoverty / TotalPop, 0),
         year = "2020") %>%
  dplyr::select(-Whites, -FemaleBachelors, -MaleBachelors, -TotalPoverty) 
```

## allTracts Creation
```{r}

allTracts <- rbind(tracts16,tracts20)
```

# Code and notes for HW2

## Pulling census tracts and ACS data for 2009 and 2017 (?) and joining them

```{r data_2009, results='hide'}
tracts09 <- 
  get_acs(geography = "tract", 
          variables = c("B25026_001E","B02001_002E",
                        "B15001_050E","B15001_009E",
                        "B19013_001E","B25058_001E",
                        "B06012_002E"), 
          year=2009, state="DC", 
          geometry=TRUE, output="wide") %>%
  st_transform('ESRI:102685') %>%
  rename(TotalPop = B25026_001E, 
         Whites = B02001_002E,
         FemaleBachelors = B15001_050E, 
         MaleBachelors = B15001_009E,
         MedHHInc = B19013_001E, 
         MedRent = B25058_001E,
         TotalPoverty = B06012_002E) %>%
  dplyr::select(-NAME, -starts_with("B")) %>%
  mutate(pctWhite = ifelse(TotalPop > 0, Whites / TotalPop,0),
         pctBachelors = ifelse(TotalPop > 0, ((FemaleBachelors + MaleBachelors) / TotalPop),0),
         pctPoverty = ifelse(TotalPop > 0, TotalPoverty / TotalPop, 0),
         year = "2009") %>%
  dplyr::select(-Whites, -FemaleBachelors, -MaleBachelors, -TotalPoverty) 
```

```{r data_2017, results='hide'}
tracts17 <- 
  get_acs(geography = "tract", 
          variables = c("B25026_001E","B02001_002E",
                        "B15001_050E","B15001_009E",
                        "B19013_001E","B25058_001E",
                        "B06012_002E"), 
          year=2017, state="DC", 
          geometry=TRUE, output="wide") %>%
  st_transform('ESRI:102685') %>%
  rename(TotalPop = B25026_001E, 
         Whites = B02001_002E,
         FemaleBachelors = B15001_050E, 
         MaleBachelors = B15001_009E,
         MedHHInc = B19013_001E, 
         MedRent = B25058_001E,
         TotalPoverty = B06012_002E) %>%
  dplyr::select(-NAME, -starts_with("B")) %>%
  mutate(pctWhite = ifelse(TotalPop > 0, Whites / TotalPop,0),
         pctBachelors = ifelse(TotalPop > 0, ((FemaleBachelors + MaleBachelors) / TotalPop),0),
         pctPoverty = ifelse(TotalPop > 0, TotalPoverty / TotalPop, 0),
         year = "2017") %>%
  dplyr::select(-Whites, -FemaleBachelors, -MaleBachelors, -TotalPoverty) 
```

```{r}
allTracts <- rbind(tracts09,tracts17)
```

## UnConverted Code: 'Wrangling Transit Open Data' Forward

## Tried writing something to pull DC metro stations based on code for SEPTA stops - Jamie
### Added in Metro lines - Timothy
```{r pull_metro_data, results='hide'}
metroStops <- st_read("https://maps2.dcgis.dc.gov/dcgis/rest/services/DCGIS_DATA/Transportation_Rail_Bus_WebMercator/MapServer/52/query?outFields=*&where=1%3D1&f=geojson") %>% 
    dplyr::select(NAME, LINE) %>%
  st_transform('ESRI:102685') #change st_transform if needed

metroLines <- st_read("https://maps2.dcgis.dc.gov/dcgis/rest/services/DCGIS_DATA/Transportation_Rail_Bus_WebMercator/MapServer/106/query?outFields=*&where=1%3D1&f=geojson") %>% 
    dplyr::select(NAME, GIS_ID) %>%
  st_transform('ESRI:102685') 
```

## View of Metro Stations & Lines
```{r view_metro_data}
ggplot() +
  geom_sf(data=tracts09)+
  geom_sf(data=metroStops, 
          show.legend = "point", size=1.2,
          color = "black")+ # str_split(LINE,",",simplify=T)[1]) maybe (too many legend entries)
  geom_sf(data=metroLines, 
          aes(colour=NAME))+
  geom_line(size=10)+
  scale_colour_manual(values=c("blue","green","orange","red","gray","yellow2"))+
  labs(color="DC Metro Lines")+
  mapTheme()
```

## Generate TOD vs non-TOD

```{r metro_buffer}
buffer <- 
  rbind(
    st_union(st_buffer(metroStops, 2640)) %>%
      st_sf() %>%
      mutate(Legend = "Unioned Buffer"))

ggplot() +
  geom_sf(data=buffer) +
  geom_sf(data=metroStops, show.legend = "point") +
  facet_wrap(~Legend) + 
  mapTheme()
```

```{r select_by_centroids}
allTracts.group <- 
  rbind(
    st_centroid(allTracts)[buffer,] %>%
      st_drop_geometry() %>%
      left_join(allTracts) %>%
      st_sf() %>%
      mutate(TOD = "TOD"),
    st_centroid(allTracts)[buffer, op = st_disjoint] %>%
      st_drop_geometry() %>%
      left_join(allTracts) %>%
      st_sf() %>%
      mutate(TOD = "Non-TOD")) %>%
  mutate(MedRent.inf = ifelse(year == "2017", MedRent * 1.1426, MedRent)) 
```

```{r TOD_table}
allTracts.Summary <- #also no idea if this works, just kind of plugged it in from the lab rmd
  st_drop_geometry(allTracts.group) %>%
    group_by(year, TOD) %>%
    summarize(Rent = mean(MedRent, na.rm = T),
              Population = mean(TotalPop, na.rm = T),
              Percent_White = mean(pctWhite, na.rm = T),
              Percent_Bach = mean(pctBachelors, na.rm = T),
              Percent_Poverty = mean(pctPoverty, na.rm = T))

kable(allTracts.Summary) %>%
  kable_styling() %>%
  footnote(general_title = "\n",
           general = "Table 1.2")
```

## Starting Multiple Ring Buffer

```{r mrb_test}
DCmetro_MRB <- multipleRingBuffer(st_union(metroStops),
                                maxDistance = 47520,
                                interval =  2640)
```

```{r visualize_mrb_test}
ggplot() + # delete this chunk in final markdown
    geom_sf(data=DCmetro_MRB) +
    geom_sf(data=metroStops, size=1) +
    geom_sf(data=st_union(tracts09), fill=NA, size=1.2) +
    labs(title="Half mile buffers") +
    mapTheme()
```

```{r all_tracts_mrb}
allTracts <- rbind(tracts09,tracts17)
DCmetro_MRB <- multipleRingBuffer(st_union(metroStops), 9240, 1320)

allTracts.rings <-
  st_join(st_centroid(dplyr::select(allTracts, GEOID, year)),
          DCmetro_MRB) %>%
  st_drop_geometry() %>%
  left_join(dplyr::select(allTracts, GEOID, MedRent, year), 
            by=c("GEOID"="GEOID", "year"="year")) %>%
  st_sf() %>%
  mutate(distance = distance / 5280) #convert to miles
  
allTracts.rings.summary <- st_drop_geometry(allTracts.rings) %>%
    group_by(distance, year) %>%
    summarize(Mean_Rent = mean(MedRent, na.rm=T))

#this graph is broken...? not sure why
ggplot(allTracts.rings.summary, 
       aes(distance, Mean_Rent, colour=year)) +
      geom_point(size=3) + 
  geom_line(size=2)
```

# ACS variable exploration

### Jamie's notes

Dropping a sample code chunk here that fetches/mutates my variables of interest.

```{r jamie_acs_vars, results='hide'}
tracts09_preRename <- 
  get_acs(geography = "tract", 
          variables = c("B25026_001E",
                        "B02001_002E",
                        "B19013_001E",
                        "B25058_001E",
                        "B06012_002E",
                        "B05012_003E", #new ones begin here
                        "B25002_003E",
                        "B25002_001E", 
                        "B25071_001E"),
          year=2009, state="DC", 
          geometry=TRUE, output="wide") %>%
  st_transform('ESRI:102685') %>%
  rename(TotalPop = B25026_001E,
         Whites = B02001_002E,
         MedHHInc = B19013_001E,
         MedRent = B25058_001E,
         TotalPoverty = B06012_002E,
         ForeignBorn = B05012_003E, #new ones begin here
         TotalHHs = B25002_001E,
         VacantHHs = B25002_003E,
         RentBurden = B25071_001E
         ) %>%
  dplyr::select(-NAME, -starts_with("B")) %>%
  mutate(pctWhite = ifelse(TotalPop > 0, Whites / TotalPop,0),
         pctPoverty = ifelse(TotalPop > 0, TotalPoverty / TotalPop, 0),
         pctForeignBorn = ifelse(TotalPop > 0, ForeignBorn / TotalPop, 0),
         pctVacant = ifelse(TotalHHs > 0, VacantHHs / TotalHHs, 0),
         avgHHsize = ifelse(TotalHHs > 0, TotalPop / TotalHHs, 0),
         year = "2009") %>%
  dplyr::select(-Whites, -TotalPoverty, -VacantHHs)
```

To summarize the new variables:
- RentBurden: median gross rent as a percentage of household income
- pctForeignBorn: percent of population born outside the US
- pctVacant: percent of households that are vacant

The story I want to tell is one of equity in transit-oriented development. Of course, building residential and commercial developments with Metro access optimizes the value of public transit and improves overall mobility, sustainability and economic resilience. However, we should consider serving the people being left behind by private free market development and suggest ways to build affordable housing near key assets like commercial corridors and Metro stations.

We can investigate this problem from multiple angles.

1. Rent burden: As rent rises and income remains constant, the percentage of income spent on rent must rise as well. This percentage represents a key factor in whether residents must relocate because of rent unaffordability. It is most critical for lower income residents because they have less disposable income and limited options for relocation.

2. Foreign born population: Those who were not born in the US disproportionately grapple with limited English proficiency, unemployment and poor access to needed cultural resources. Transit access provides immigrants with opportunities to travel to language and job training, as well as to communities with shared culture and language.

3. Vacancy: Neighborhood vacancy rate is influenced by many factors, one of which being housing demand. A lower vacancy rate can indicate more stress on housing supply and even suggest that an area may be undergoing a housing crisis.

4. Racial and economic segregation: Although Metro access may be associated with increasing land and housing value, those with the greatest access to financial and social resources may also be securing large proportions of limited property around Metro stations and thereby limiting opportunities for less well-resourced communities. Tracking the index of concentration at the extremes over time captures the changing extent of racial and economic segregation in a given area, which is of great interest in an equitable development plan.

### Timothy's code & notes
```{r Timothy_Vars, results='hide'}

## Need to get right variables still --different year has different variable name
tracts_2009 <-
  get_acs(geography = "tract",

          #             Var ID          Intended Name for Column
          variables = c("B25026_001E", # total pop
                        "B02001_002E", # # of whites
                        "B15001_050E", # # of female w/ bachelor's
                        "B15001_009E", # # of male w/ bachelor's
                        "B19013_001E", # median household income
                        "B25058_001E", # median rent
                        "B06012_002E", # total poverty
                        "B01003_001E", # Estimated Total Population
                        "B05001PR_001E",
                        "B05001PR_006E",
                        "B08105G_001E", # total of means of transport to work
                        "B08105G_004E", # means of transport to work, Public Transportation
                        "B08119_028E", # total records for earnings of Public Tranit users for means of transport
                        "B08119_029E",
                        "B08119_030E",
                        "B08119_031E",
                        "B08119_032E",
                        "B08119_033E",
                        "B08119_034E",
                        "B08119_035E",
                        "B08119_036E",
                        "B08534_091E", # total respondents for rail/ferryway public transit users travel time to work
                        "B08534_092E",
                        "B08534_093E",
                        "B08534_094E",
                        "B08534_095E",
                        "B08534_096E",
                        "B08534_097E",
                        "B08534_098E",
                        "B08534_099E",
                        "B08534_100E"
                        ),

          year=2009, state="DC", geometry=TRUE) %>%
  st_transform('ESRI:102685') # %>% # Maryland's State Plane CS, check if pipe is uncommented
  # it says none of these variables exist!, I can get estimates and moes though
  # rename(TotalPop = B25026_001E,
  #        Whites = B02001_002E,
  #        FemaleBachelors = B15001_050E,
  #        MaleBachelors = B15001_009E,
  #        MedHHInc = B19013_001E,
  #        MedRent = B25058_001E,
  #        TotalPoverty = B06012_002E,
  #        TotalUSCitizens = B05001PR_001E,
  #        TotalNotCitizens = B05001PR_006E,
  #        TotalMeansofTransitToWork = B08105G_001E,
  #        TotalPubTransitUsers = B08105G_004E,
  #        Total_public_transit_users_reporting_earnings = B08119_028E,
  #        TotalPubRailUsers = B08534_091E
  #        ) %>%
  # dplyr::select(-NAME, -starts_with("B")) %>%
  # mutate(pctWhite = ifelse(TotalPop > 0, Whites / TotalPop,0),
  #        pctBachelors = ifelse(TotalPop > 0, ((FemaleBachelors + MaleBachelors) / TotalPop),0),
  #        pctPoverty = ifelse(TotalPop > 0, TotalPoverty / TotalPop, 0),
  #        year = "2020") %>%
  # dplyr::select(-Whites, -FemaleBachelors, -MaleBachelors, -TotalPoverty)
```

### xxx's notes
```{r Name_Vars, results='hide'}
```


```{r sessionInfo, include = F}
# this makes a text file with the libraries and info about your system (so that you can tell what you needed to run this in the future)
write(capture.output(sessionInfo()),file="requirements.txt")
```

